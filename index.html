<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文献资料库 (腾讯云版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 引入腾讯云 CloudBase SDK -->
    <!-- [修复] 切换到腾讯云官方另一个更稳定的 CDN 地址 -->
    <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.21.6/cloudbase.full.js?v=1"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        @supports ((-webkit-line-clamp: 3) or (line-clamp: 3)) {
            .line-clamp-3 {
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 3;
                line-clamp: 3;
                -webkit-box-orient: vertical;
            }
        }

        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }

        .modal-content {
            transition: transform 0.2s ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <!-- 导航栏 -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-gray-800">文献资料库</div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="container mx-auto px-6 py-8">

        <!-- 搜索和操作栏 -->
        <div class="mb-8 md:flex md:items-center md:justify-between">
            <!-- 搜索栏 -->
            <div class="relative flex-grow">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <input type="text" id="searchInput"
                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="搜索标题、简介或分类 (例如: 论文)...">
            </div>

            <!-- 添加资料按钮 -->
            <button id="addDocButton"
                class="w-full md:w-auto mt-4 md:mt-0 md:ml-4 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-colors">
                添加新资料
            </button>
        </div>

        <!-- 资料卡片网格 -->
        <div id="documentList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- 资料卡片将在这里动态生成 -->
        </div>

        <!-- 加载中/无结果 -->
        <div id="noResults" class="hidden text-center text-gray-500 mt-12">
            <!-- 初始加载状态 -->
            <div id="loadingState">
                <svg class="animate-spin mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <h3 class="mt-2 text-lg font-medium text-gray-900">正在加载资料...</h3>
                <p class="text-sm mt-2">请稍候，正在连接到数据库。</p>
            </div>
            <!-- 无结果状态 -->
            <div id="emptyState" class="hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="1">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 10v.01M10 10h.01M10 10l.01.01M10 10l-.01.01M10 10l.01-.01M10 10l-.01-.01M14 10v.01M14 10h.01M14 10l.01.01M14 10l-.01.01M14 10l.01-.01M14 10l-.01-.01M18 10v.01M18 10h.01M18 10l.01.01M18 10l-.01.01M18 10l.01-.01M18 10l-.01-.01M6 10v.01M6 10h.01M6 10l.01.01M6 10l-.01.01M6 10l.01-.01M6 10l-.01-.01M10 14v.01M10 14h.01M10 14l.01.01M10 14l-.01.01M10 14l.01-.01M10 14l-.01-.01M10 18v.01M10 18h.01M10 18l.01.01M10 18l-.01.01M10 18l.01-.01M10 18l-.01-.01M10 6v.01M10 6h.01M10 6l.01.01M10 6l-.01.01M10 6l.01-.01M10 6l-.01-.01" />
                </svg>
                <h3 class="mt-2 text-lg font-medium text-gray-900">未找到资料</h3>
                <p class="text-sm mt-2">请尝试更改您的搜索关键词，或添加第一份资料。</p>
            </div>
        </div>

    </main>

    <!-- 添加资料模态框 (Modal) -->
    <div id="addDocModal"
        class="modal-overlay fixed inset-0 z-50 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div
            class="modal-content bg-white w-full max-w-lg rounded-lg shadow-xl overflow-hidden transform scale-95 opacity-0">
            <!-- 头部 -->
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-xl font-semibold text-gray-900">添加新资料</h3>
                <button id="closeModalButton" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- 表单 -->
            <form id="addDocForm">
                <div class="p-6 space-y-4">
                    <div id="formError" class="hidden p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">标题</label>
                        <input type="text" name="title" id="title"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-1">简介</label>
                        <textarea name="description" id="description" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required></textarea>
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-1">分类</label>
                        <select name="category" id="category"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required>
                            <option value="">请选择一个分类</option>
                            <option value="学术论文">学术论文</option>
                            <option value="翻译资料">翻译资料</option>
                            <option value="行业报告">行业报告</option>
                            <option value="内部文档">内部文档</option>
                        </select>
                    </div>
                    <div>
                        <label for="link" class="block text-sm font-medium text-gray-700 mb-1">分享链接 (URL)</label>
                        <input type="url" name="link" id="link"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="https://..." required>
                    </div>
                </div>
                <!-- 底部 -->
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
                    <button type="button" id="cancelButton"
                        class="px-5 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        取消
                    </button>
                    <button type="submit" id="saveButton"
                        class="relative px-5 py-2 bg-blue-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <span id="saveButtonText">保存</span>
                        <div id="saveSpinner" class="hidden absolute inset-0 flex items-center justify-center">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                        </div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div id="confirmDeleteModal"
        class="modal-overlay fixed inset-0 z-50 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div
            class="modal-content bg-white w-full max-w-md rounded-lg shadow-xl overflow-hidden transform scale-95 opacity-0">
            <!-- 头部 -->
            <div class="flex items-start justify-between p-5 border-b">
                <div class="flex items-center space-x-3">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">确认删除</h3>
                </div>
                <button id="closeConfirmModalButton" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- 内容 -->
            <div class="p-6">
                <p class="text-sm text-gray-600">
                    您确定要删除这份资料吗？此操作无法撤销。
                </p>
                <p id="confirmDeleteMessage" class="text-sm text-gray-700 font-medium mt-2"></p>
            </div>
            <!-- 底部 -->
            <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
                <button type="button" id="cancelDeleteButton"
                    class="px-5 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    取消
                </button>
                <button type="button" id="confirmDeleteButton"
                    class="relative px-5 py-2 bg-red-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    确认删除
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Wait for the DOM to be fully loaded before querying elements
        document.addEventListener('DOMContentLoaded', () => {

            // --- 腾讯云 TCB 配置 ---
            // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            //
            //  重要：请将 'YOUR_ENV_ID' 替换为您在腾讯云 CloudBase 控制台中获取的“环境ID”
            //  请参考 instructions-tcb.md 文件获取详细指南
            //
            // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            const TCB_ENV_ID = 'cloud1-9gfk1fl37e4b5266';

            // --- DOM 元素 ---
            const searchInput = document.getElementById('searchInput');
            const documentList = document.getElementById('documentList');
            const noResults = document.getElementById('noResults');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');

            // 模态框 DOM
            const addDocModal = document.getElementById('addDocModal');
            const modalContent = addDocModal.querySelector('.modal-content');
            const addDocButton = document.getElementById('addDocButton');
            const closeModalButton = document.getElementById('closeModalButton');
            const cancelButton = document.getElementById('cancelButton');
            const addDocForm = document.getElementById('addDocForm');
            const saveButton = document.getElementById('saveButton');
            const saveButtonText = document.getElementById('saveButtonText');
            const saveSpinner = document.getElementById('saveSpinner');
            const formError = document.getElementById('formError');

            // 确认删除模态框 DOM
            const confirmDeleteModal = document.getElementById('confirmDeleteModal');
            const confirmModalContent = confirmDeleteModal.querySelector('.modal-content');
            const closeConfirmModalButton = document.getElementById('closeConfirmModalButton');
            const cancelDeleteButton = document.getElementById('cancelDeleteButton');
            const confirmDeleteButton = document.getElementById('confirmDeleteButton');
            const confirmDeleteMessage = document.getElementById('confirmDeleteMessage');

            // --- App State ---
            let userId, db, documentsCollection;
            let allDocuments = []; // 用于搜索的本地缓存
            let docIdToDelete = null; // 存储待删除的文档ID
            let dbWatcher = null; // 数据库监听器

            // --- TCB 初始化 ---
            let c;
            try {
                // [修复] 检查 cloudbase 变量是否存在
                if (typeof cloudbase === 'undefined') {
                    throw new Error("TCB SDK 加载失败 (cloudbase is not defined)。请检查网络连接或浏览器插件。");
                }

                if (TCB_ENV_ID === 'YOUR_ENV_ID') {
                    throw new Error("请在 index.html 文件中配置您的 TCB_ENV_ID");
                }

                c = cloudbase.init({
                    env: TCB_ENV_ID
                });
                console.log("TCB SDK 初始化成功");
            } catch (e) {
                console.error("TCB 初始化失败:", e);
                showError(e.message);
                return;
            }

            const auth = c.auth();
            db = c.database();
            // TCB 数据库的集合名称
            const COLLECTION_NAME = "documents";
            documentsCollection = db.collection(COLLECTION_NAME);

            // --- 错误处理 ---
            function showError(message) {
                documentList.classList.add('hidden');
                noResults.classList.remove('hidden');
                loadingState.classList.add('hidden');
                emptyState.classList.remove('hidden');
                emptyState.innerHTML = `<h3 class="mt-2 text-lg font-medium text-red-700">加载失败</h3><p class="text-sm mt-2">${message}</p><p class="text-xs mt-2 text-gray-500">请检查您的 TCB_ENV_ID 配置和网络连接。</p>`;
            }

            // --- 模态框控制 (与之前相同) ---
            function openModal() {
                addDocForm.reset();
                formError.classList.add('hidden');
                addDocModal.classList.remove('hidden');
                setTimeout(() => {
                    addDocModal.classList.remove('opacity-0');
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            function closeModal() {
                addDocModal.classList.add('opacity-0');
                modalContent.classList.add('scale-95', 'opacity-0');
                modalContent.classList.remove('scale-100', 'opacity-100');
                setTimeout(() => {
                    addDocModal.classList.add('hidden');
                }, 200);
            }

            function openConfirmModal(docId, docTitle) {
                docIdToDelete = docId;
                confirmDeleteMessage.textContent = `即将删除: "${docTitle}"`;
                confirmDeleteModal.classList.remove('hidden');
                setTimeout(() => {
                    confirmDeleteModal.classList.remove('opacity-0');
                    confirmModalContent.classList.remove('scale-95', 'opacity-0');
                    confirmModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            function closeConfirmModal() {
                confirmDeleteModal.classList.add('opacity-0');
                confirmModalContent.classList.add('scale-95', 'opacity-0');
                confirmModalContent.classList.remove('scale-100', 'opacity-100');
                setTimeout(() => {
                    confirmDeleteModal.classList.add('hidden');
                    docIdToDelete = null;
                    confirmDeleteMessage.textContent = "";
                }, 200);
            }

            // --- 辅助函数：获取分类颜色 (与之前相同) ---
            function getCategoryClass(category) {
                switch (category) {
                    case "学术论文": return "bg-blue-100 text-blue-800";
                    case "翻译资料": return "bg-green-100 text-green-800";
                    case "行业报告": return "bg-purple-100 text-purple-800";
                    case "内部文档": return "bg-yellow-100 text-yellow-800";
                    default: return "bg-gray-100 text-gray-800";
                }
            }

            // --- 核心功能：渲染文档列表 ---
            function renderDocuments(documents) {
                documentList.innerHTML = '';

                if (documents.length === 0) {
                    // 如果搜索结果为空
                    if (allDocuments.length > 0) {
                        // 数据库有数据，只是没搜到
                        noResults.classList.remove('hidden');
                        loadingState.classList.add('hidden');
                        emptyState.classList.remove('hidden');
                        emptyState.innerHTML = '<h3 class="mt-2 text-lg font-medium text-gray-900">未找到资料</h3><p class="text-sm mt-2">请尝试更改您的搜索关键词。</p>';
                    } else {
                        // 数据库也为空
                        noResults.classList.remove('hidden');
                        loadingState.classList.add('hidden');
                        emptyState.classList.remove('hidden');
                        emptyState.innerHTML = '<h3 class="mt-2 text-lg font-medium text-gray-900">资料库为空</h3><p class="text-sm mt-2">请点击“添加新资料”来分享您的第一份文档。</p>';
                    }
                    documentList.classList.add('hidden');
                } else {
                    noResults.classList.add('hidden');
                    documentList.classList.remove('hidden');
                }

                documents.forEach(doc => {
                    const categoryClasses = getCategoryClass(doc.category);
                    // TCB 返回的日期可能是时间戳对象，也可能是字符串，确保格式化
                    let displayDate = '无日期'; // 默认值

                    try {
                        // TCB 返回的日期可能是时间戳对象，也可能是字符串
                        // 我们需要一个健壮的解析
                        if (doc.date) {
                            // 尝试将其创建为 Date 对象
                            const dateObj = new Date(doc.date);
                            // 检查是否为有效日期
                            if (!isNaN(dateObj.getTime())) {
                                displayDate = dateObj.toISOString().split('T')[0];
                            }
                        }
                    } catch (e) {
                        console.warn("日期解析失败:", doc.date);
                    }

                    const card = `
                        <div class="document-card bg-white rounded-lg shadow-lg overflow-hidden flex flex-col">
                            <div class="p-6 flex-grow">
                                <span class="${categoryClasses} text-xs font-semibold px-2.5 py-0.5 rounded-full">${doc.category}</span>
                                <h3 class="text-xl font-bold text-gray-900 mt-3 mb-2">${doc.title}</h3>
                                <p class="text-gray-600 text-sm mb-4 line-clamp-3" title="${doc.description}">
                                    ${doc.description}
                                </p>
                            </div>
                            <div class="bg-gray-50 px-6 py-4 flex justify-between items-center">
                                <span class="text-gray-500 text-sm">${displayDate}</span>
                                <div class="flex space-x-2">
                                    <a href="${doc.link}" target="_blank" 
                                       class="text-sm font-medium text-white bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                       查看详情
                                    </a>
                                    <button
                                       class="delete-button text-sm font-medium text-red-600 bg-red-100 px-4 py-2 rounded-lg hover:bg-red-200 transition-colors"
                                       data-doc-id="${doc.id}">
                                       删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    documentList.innerHTML += card;
                });
            }

            // --- 核心功能：过滤文档 (与之前相同) ---
            function filterDocuments() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                if (!searchTerm) {
                    renderDocuments(allDocuments);
                    return;
                }
                const filtered = allDocuments.filter(doc => {
                    const titleMatch = doc.title.toLowerCase().includes(searchTerm);
                    const descriptionMatch = doc.description.toLowerCase().includes(searchTerm);
                    const categoryMatch = doc.category.toLowerCase().includes(searchTerm);
                    return titleMatch || descriptionMatch || categoryMatch;
                });
                renderDocuments(filtered);
            }

            // --- 核心功能：加载 TCB 文档 ---
            function loadDocuments() {
                console.log("开始监听数据库...");
                noResults.classList.remove('hidden'); // 显示加载中
                loadingState.classList.remove('hidden');
                emptyState.classList.add('hidden');

                // 使用 TCB 的 watch 实时监听
                dbWatcher = documentsCollection
                    .watch({
                        onChange: (snapshot) => {
                            console.log("TCB 数据快照更新:", snapshot);
                            if (snapshot.error) {
                                console.error("TCB 监听错误:", snapshot.error);
                                showError(`数据库监听失败: ${snapshot.error.message}。请检查您的 TCB 数据库安全规则。`);
                                return;
                            }

                            allDocuments = []; // 清空本地缓存
                            snapshot.docs.forEach((doc) => {
                                // [诊断代码] 打印 doc.date 的结构
                                console.log("【诊断】正在检查 doc.date 对象:", doc.date, "它的类型是:", typeof doc.date);

                                // 我们必须在这里立即处理它
                                let parsableDate = null;

                                // [最终修复 v5 - 基于数据库截图 image_ce88bd.png]
                                // 数据库截图证明，doc.date 是一个标准日期字符串
                                if (doc.date && typeof doc.date === 'string') {
                                    // 1. 它已经是一个字符串了，直接用它！
                                    parsableDate = doc.date;
                                }
                                // 备用方案 (以防万一，它是一个实时对象)
                                else if (doc.date && typeof doc.date.toDate === 'function') {
                                    parsableDate = doc.date.toDate().toISOString();
                                }
                                // 备用方案 (以防万一，控制台的对象也是对的)
                                else if (doc.date && typeof doc.date === 'object' && doc.date.$date) {
                                    const timestamp = Number(doc.date.$date);
                                    if (!isNaN(timestamp)) {
                                        parsableDate = new Date(timestamp).toISOString();
                                    }
                                }

                                const newDoc = {
                                    id: doc._id,
                                    ...doc,
                                    date: parsableDate // 用可解析的 ISO 字符串覆盖 date 字段
                                };

                                delete newDoc._openid;
                                delete newDoc._id; // 已经有 id
                                allDocuments.push(newDoc);
                            });

                            // [修改] 排序逻辑现在可以安全地 new Date()


                            // [新增] 在客户端进行排序 (带安全检查)
                            allDocuments.sort((a, b) => {
                                const dateA = a.date ? new Date(a.date).getTime() : 0;
                                const dateB = b.date ? new Date(b.date).getTime() : 0;
                                // 检查无效日期
                                if (isNaN(dateA)) dateA = 0;
                                if (isNaN(dateB)) dateB = 0;
                                return dateB - dateA;
                            });

                            // 重新渲染
                            filterDocuments();
                        },
                        onError: (error) => {
                            console.error("TCB 监听器发生严重错误:", error);
                            showError(`数据库连接断开: ${error.message}`);
                        }
                    });
            }

            // --- 核心功能：删除文档 ---
            async function handleDeleteClick(docId) {
                if (!docId || !documentsCollection) {
                    console.error("无法删除：缺少文档ID或集合");
                    return;
                }
                console.log(`正在删除文档: ${docId}`);
                try {
                    // TCB 使用 .doc(id).remove()
                    await documentsCollection.doc(docId).remove();
                    // watch 会自动处理UI更新
                    console.log("删除成功");
                } catch (error) {
                    console.error("删除失败: ", error);
                    alert(`删除失败: ${error.message}`); // 简单提示
                }
            }

            // --- 核心功能：保存新文档 ---
            async function saveDocument(event) {
                event.preventDefault();
                if (!documentsCollection) return;

                formError.classList.add('hidden');
                saveButton.disabled = true;
                saveButtonText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');

                try {
                    const formData = new FormData(addDocForm);
                    const newDoc = {
                        title: formData.get('title'),
                        description: formData.get('description'),
                        category: formData.get('category'),
                        link: formData.get('link'),
                        // TCB 推荐使用 db.serverDate() 来获取服务器时间
                        date: db.serverDate()
                    };

                    if (!newDoc.title || !newDoc.description || !newDoc.category || !newDoc.link) {
                        throw new Error("请填写所有字段。");
                    }

                    // TCB 使用 .add()
                    await documentsCollection.add(newDoc);

                    closeModal(); // 成功后关闭模态框
                } catch (error) {
                    console.error("保存失败: ", error);
                    formError.textContent = `保存失败: ${error.message}`;
                    formError.classList.remove('hidden');
                } finally {
                    saveButton.disabled = false;
                    saveButtonText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                }
            }

            // --- 事件监听 (与之前相同) ---
            searchInput.addEventListener('keyup', filterDocuments);
            addDocButton.addEventListener('click', openModal);
            closeModalButton.addEventListener('click', closeModal);
            cancelButton.addEventListener('click', closeModal);
            addDocForm.addEventListener('submit', saveDocument);

            documentList.addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-button');
                if (deleteButton) {
                    event.preventDefault();
                    const docId = deleteButton.dataset.docId;
                    const docToDelete = allDocuments.find(d => d.id === docId);
                    const docTitle = docToDelete ? docToDelete.title : "未知资料";
                    if (docId) {
                        openConfirmModal(docId, docTitle);
                    }
                }
            });

            closeConfirmModalButton.addEventListener('click', closeConfirmModal);
            cancelDeleteButton.addEventListener('click', closeConfirmModal);
            confirmDeleteButton.addEventListener('click', () => {
                if (docIdToDelete) {
                    handleDeleteClick(docIdToDelete);
                }
                closeConfirmModal();
            });

            // --- TCB 认证和启动 ---
            async function main() {
                try {
                    // 1. 检查当前登录状态
                    const loginState = await auth.getLoginState();
                    if (!loginState) {
                        console.log("用户未登录，尝试匿名登录...");
                        // 2. 如果未登录，执行匿名登录
                        await auth.signInAnonymously();
                        const newState = await auth.getLoginState();
                        userId = newState.user.uid;
                        console.log("TCB 匿名登录成功:", userId);
                    } else {
                        userId = loginState.user.uid;
                        console.log("TCB 用户已认证:", userId);
                    }

                    // 3. 开始加载文档
                    loadDocuments();

                } catch (error) {
                    console.error("TCB 认证或登录失败:", error);
                    showError(`认证失败: ${error.message}。请检查您的 TCB 环境是否开启了匿名登录。`);
                }
            }

            main(); // 启动应用

        }); // End of DOMContentLoaded
    </script>
</body>

</html>